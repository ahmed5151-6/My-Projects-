<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RJ Machinery Store</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background: #1e3a8a; font-family: sans-serif; color: #333; }
        .hero { background: #1e40af; color: white; text-align: center; padding: 1.5rem 1rem; position: relative; }
        .status-pill { position: absolute; top: 10px; right: 10px; font-size: 10px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 20px; }
        .tab-nav { display: flex; background: #e2e8f0; sticky; top: 0; z-index: 50; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; font-size: 13px; font-weight: bold; color: #1e40af; border-bottom: 4px solid transparent; white-space: nowrap; }
        .tab-btn.active { background: #2563eb; color: white; border-bottom: 4px solid #fff; }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; }
        .btn-blue { background: #2563eb; color: white; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; }
        
        /* Amazon Style Item Card */
        .item-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #2563eb; }
        .stock-bar-bg { background: #eee; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .stock-bar-fill { background: #10b981; height: 100%; transition: width 0.3s; }
        .low-stock-fill { background: #ef4444 !important; }
        .warning-text { color: #ef4444; font-size: 10px; font-weight: 900; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .rj-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; border-collapse: collapse; }
        .rj-table th { padding: 12px 10px; background: white; color: #1e3a8a; font-weight: 900; font-size: 11px; text-align: left; border-bottom: 2px solid #eee; }
        .rj-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; color: #1e3a8a; font-weight: 600; font-size: 12px; }
        .strip-card { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 10px; color: white; border-left: 6px solid; }
        
        #receiptModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; padding: 20px; }
        .receipt-box { background: white; padding: 15px; border-radius: 10px; max-width: 400px; margin: auto; }
    </style>
</head>
<body>
    <div class="hero">
        <div id="syncStatus" class="status-pill">üì± Loading...</div>
        <h1 class="text-2xl font-bold">‚öôÔ∏è RJ Machinery Store</h1>
        <p class="opacity-80 text-xs">Hybrid Cloud Inventory</p>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openT(event,'stk')">üì¶ Stocks</button>
        <button class="tab-btn" onclick="openT(event,'cus')">üë• Customers</button>
        <button class="tab-btn" onclick="openT(event,'pnd')">‚è≥ Pending</button>
        <button class="tab-btn" onclick="openT(event,'hst')">üìú History</button>
        <button class="tab-btn" onclick="openT(event,'bil')">üí∞ Bill</button>
    </div>

    <div id="stk" class="tab-content active">
        <div class="card"><h2 class="text-xl font-bold text-blue-900 mb-4" id="itemFormTitle">Add Item</h2><input type="hidden" id="i-id"><input id="iN" class="field" placeholder="Item Name"><input id="iR" type="number" class="field" placeholder="Price"><input id="iS" type="number" class="field" placeholder="Total Qty"><button class="btn-blue" onclick="sI()">Save Item</button></div>
        <div id="iList" class="grid grid-cols-2 gap-3"></div>
    </div>

    <div id="cus" class="tab-content">
        <div class="card"><h2 class="text-xl font-bold text-blue-900 mb-4" id="custFormTitle">New Customer</h2><input type="hidden" id="c-id"><input id="cN" class="field" placeholder="Name"><input id="cS" class="field" placeholder="Shop Name"><input id="cP" class="field" placeholder="Phone"><button class="btn-blue" onclick="sC()">Save Customer</button></div>
        <div class="overflow-x-auto"><table class="rj-table"><thead><tr><th>NAME</th><th>SHOP</th><th>PHONE</th><th>ACTION</th></tr></thead><tbody id="cBody"></tbody></table></div>
    </div>

    <div id="bil" class="tab-content">
        <div class="card">
            <h2 class="text-xl font-bold text-blue-900 mb-4">Create Invoice</h2>
            <select id="bC" class="field"></select><select id="bI" class="field"></select><input id="bQ" type="number" class="field" value="1">
            <button class="btn-blue border-2 border-blue-500 bg-transparent text-blue-500 mb-4" onclick="addB()">+ Add to Bill</button>
            <div id="cartD" class="hidden border-t pt-4">
                <div class="flex justify-between items-center mb-2"><p class="font-bold text-blue-800">Selected Items:</p><button onclick="clearCart()" class="text-red-500 text-xs font-bold border border-red-500 px-2 py-1 rounded">‚ùå Clear Cart</button></div>
                <div id="cartL" class="text-sm mb-2 border-b pb-2"></div>
                <p id="tD" class="font-bold text-blue-900 text-lg mb-4 text-right"></p>
                <div class="flex gap-2"><button class="btn-blue flex-1" onclick="sale(false)">Sell Now</button><button class="btn-blue bg-gray-500 flex-1" onclick="sale(true)">Pending</button></div>
            </div>
        </div>
    </div>

    <div id="pnd" class="tab-content"><h2 class="text-yellow-400 font-bold mb-4 text-xl">‚ö†Ô∏è PENDING</h2><div id="pList"></div></div>
    <div id="hst" class="tab-content"><h2 class="text-green-400 font-bold mb-4 text-xl">‚úÖ HISTORY</h2><div id="hList"></div></div>

    <div id="receiptModal"><div class="receipt-box"><div id="pArea" class="border border-black p-4 text-xs font-mono"><h2 class="text-center font-bold text-base">RJ MACHINERY STORE</h2><hr class="my-2 border-black"><div id="rBody"></div><hr class="my-2 border-black"></div><div class="flex gap-2 mt-4"><button class="btn-blue flex-1" onclick="closeR()">Close</button><button class="btn-blue bg-green-600 flex-1" onclick="pdf()">Save PDF</button></div></div></div>

    <script>
        const URL = "https://script.google.com/macros/s/AKfycbxGSSUDzWhRqGRF13ljdH13HvgqoqF1n_U3du8rszPtdv3JsK22F-YKsyxfaSBO1Ax_/exec";
        let items=[], custs=[], pends=[], hist=[], cart=[];

        function saveLocal() {
            localStorage.setItem('rj_items', JSON.stringify(items));
            localStorage.setItem('rj_custs', JSON.stringify(custs));
            localStorage.setItem('rj_pends', JSON.stringify(pends));
            localStorage.setItem('rj_hist', JSON.stringify(hist));
        }

        function loadLocal() {
            items = JSON.parse(localStorage.getItem('rj_items')) || [];
            custs = JSON.parse(localStorage.getItem('rj_custs')) || [];
            pends = JSON.parse(localStorage.getItem('rj_pends')) || [];
            hist = JSON.parse(localStorage.getItem('rj_hist')) || [];
            render();
        }

        async function sync() {
            try {
                updateStatus("üì° Syncing...", "text-yellow-300");
                const [ri, rc] = await Promise.all([fetch(URL+"?action=getData&tab=Items"), fetch(URL+"?action=getData&tab=Customers")]);
                const di = await ri.json(), dc = await rc.json();
                if(di.length>1) items = di.slice(1).map(r=>({id:r[0],n:r[1],r:r[2],s:parseInt(r[3]),mx:parseInt(r[4]||r[3])}));
                if(dc.length>1) custs = dc.slice(1).map(r=>({id:r[0],n:r[1],s:r[2],p:r[3]}));
                saveLocal(); render();
                updateStatus("‚úÖ Online", "text-green-300");
            } catch(e) { updateStatus("üì± Local Mode", "text-red-300"); }
        }

        function cloud(t, v, action="saveData") { fetch(URL+"?action="+action,{method:"POST",mode:"no-cors",body:JSON.stringify({tab:t,values:v})}); }
        function updateStatus(m, c) { const e=document.getElementById('syncStatus'); e.innerText=m; e.className=`status-pill ${c}`; }

        function render() {
            // Items Cards with Delete
            document.getElementById('iList').innerHTML = items.map(i=>{
                let p = (i.s / i.mx) * 100; let low = i.s <= 3;
                return `<div class="item-card"><p class="font-bold text-sm text-gray-700">${i.n}</p><p class="text-blue-600 font-black text-lg">Rs.${i.r}</p>
                <div class="stock-bar-bg"><div class="stock-bar-fill ${low?'low-stock-fill':''}" style="width:${p}%"></div></div>
                <div class="flex justify-between items-center"><p class="text-[10px] font-bold">Qty: ${i.s}/${i.mx}</p>${low?'<span class="warning-text">‚ö†Ô∏è LOW</span>':''}</div>
                <div class="flex gap-1 mt-3">
                    <button onclick="edI(${i.id})" class="flex-1 border py-1 text-[10px] rounded font-bold bg-gray-50">EDIT</button>
                    <button onclick="delI(${i.id})" class="flex-1 border py-1 text-[10px] rounded font-bold bg-red-50 text-red-600 border-red-200">DEL</button>
                </div></div>`;
            }).join('');

            // Customers with Delete
            document.getElementById('cBody').innerHTML = custs.map(c=>`<tr><td>${c.n}</td><td>${c.s}</td><td>${c.p}</td>
                <td><div class="flex gap-2">
                    <button onclick="edC(${c.id})" class="text-blue-500 underline text-[10px] font-bold">Edit</button>
                    <button onclick="delC(${c.id})" class="text-red-500 underline text-[10px] font-bold">Del</button>
                </div></td></tr>`).join('');
            
            // Other Renders
            document.getElementById('pList').innerHTML = pends.map(o=>`<div class="strip-card" style="border-color:#fbbf24"><p class="font-bold">${o.cn} - Rs.${o.t}</p><div class="flex gap-2 mt-2"><button onclick="doneP(${o.id})" class="bg-white text-blue-900 px-3 py-1 rounded text-[10px] font-bold">DONE</button><button onclick="cancelP(${o.id})" class="bg-red-500 text-white px-3 py-1 rounded text-[10px] font-bold">CANCEL</button></div></div>`).join('');
            document.getElementById('hList').innerHTML = hist.slice().reverse().map(h=>`<div class="strip-card" style="border-color:#10b981"><p class="font-bold">${h.cn} - Rs.${h.t}</p><button onclick="viewR(${h.id})" class="bg-white text-blue-900 px-3 py-1 mt-2 rounded text-[10px] font-bold">üìÑ RECEIPT</button></div>`).join('');
            document.getElementById('bC').innerHTML = custs.map(c=>`<option value="${c.id}">${c.n}</option>`).join('');
            document.getElementById('bI').innerHTML = items.map(i=>`<option value="${i.id}">${i.n}</option>`).join('');
        }

        // --- NEW DELETE FUNCTIONS ---
        function delI(id) { if(confirm("Delete this Item from Stock?")) { items = items.filter(x=>x.id != id); saveLocal(); render(); cloud("Items", id, "deleteData"); } }
        function delC(id) { if(confirm("Delete this Customer?")) { custs = custs.filter(x=>x.id != id); saveLocal(); render(); cloud("Customers", id, "deleteData"); } }

        function sI() {
            const id=document.getElementById('i-id').value, n=document.getElementById('iN').value, r=document.getElementById('iR').value, q=parseInt(document.getElementById('iS').value);
            if(!n || !r) return; let fid=id||Date.now();
            if(id) items=items.map(i=>i.id==id?{...i,n,r,s:q,mx:q}:i); else items.push({id:fid,n,r,s:q,mx:q});
            cloud("Items",[fid,n,r,q,q]); clearFields(['iN','iR','iS','i-id']); document.getElementById('itemFormTitle').innerText="Add Item"; saveLocal(); render();
        }

        function sC() {
            const id=document.getElementById('c-id').value, n=document.getElementById('cN').value, s=document.getElementById('cS').value, p=document.getElementById('cP').value;
            if(!n) return; let fid=id||Date.now();
            if(id) custs=custs.map(c=>c.id==id?{id:fid,n,s,p}:c); else custs.push({id:fid,n,s,p});
            cloud("Customers",[fid,n,s,p]); clearFields(['cN','cS','cP','c-id']); document.getElementById('custFormTitle').innerText="New Customer"; saveLocal(); render();
        }

        function sale(isP) {
            const ci=document.getElementById('bC').value; if(!ci || !cart.length) return;
            const c=custs.find(cu=>cu.id==ci), t=cart.reduce((s,i)=>s+i.tot,0), rec={id:Date.now(), cn:c.n, its:[...cart], t, tm:new Date().toLocaleString()};
            if(!isP) {
                cart.forEach(ct=>{ let i=items.find(x=>x.id==ct.id); if(i){ i.s-=ct.q; cloud("Items",[i.id,i.n,i.r,i.s,i.mx]); } });
                hist.push(rec); cloud("History",[rec.id,rec.cn,rec.t,rec.tm]);
            } else { pends.push(rec); cloud("Pending",[rec.id,rec.cn,rec.t,rec.tm]); }
            cart=[]; document.getElementById('cartD').classList.add('hidden'); saveLocal(); render(); alert("Saved!");
        }

        function doneP(id) {
            const o = pends.find(x=>x.id==id);
            o.its.forEach(ct=>{ let i=items.find(x=>x.id==ct.id); if(i){ i.s-=ct.q; cloud("Items",[i.id,i.n,i.r,i.s,i.mx]); } });
            hist.push(o); pends=pends.filter(x=>x.id!=id); saveLocal(); render();
        }

        function edI(id) { const i=items.find(x=>x.id==id); document.getElementById('i-id').value=i.id; document.getElementById('iN').value=i.n; document.getElementById('iR').value=i.r; document.getElementById('iS').value=i.s; document.getElementById('itemFormTitle').innerText="Update Item"; window.scrollTo(0,0); }
        function edC(id) { const c=custs.find(x=>x.id==id); document.getElementById('c-id').value=c.id; document.getElementById('cN').value=c.n; document.getElementById('cS').value=c.s; document.getElementById('cP').value=c.p; document.getElementById('custFormTitle').innerText="Update Customer"; window.scrollTo(0,0); }
        
        function clearCart() { if(confirm("Clear bill?")) { cart=[]; document.getElementById('cartD').classList.add('hidden'); renderB(); } }
        function cancelP(id) { if(confirm("Cancel order?")) { pends=pends.filter(x=>x.id!=id); saveLocal(); render(); } }
        function viewR(id) { const h = hist.find(x=>x.id==id); let rows = h.its.map(i=>`<div class="flex justify-between"><span>${i.n} x${i.q}</span><span>${i.tot}</span></div>`).join(''); document.getElementById('rBody').innerHTML = `<p><b>ID:</b> ${h.id}</p><p><b>Time:</b> ${h.tm}</p><p><b>Cust:</b> ${h.cn}</p><hr class="my-2 border-dashed border-gray-400">${rows}<hr class="my-2 border-dashed border-gray-400"><p class="text-right font-bold text-sm">TOTAL: Rs.${h.t}</p>`; document.getElementById('receiptModal').style.display='block'; }
        function addB() { const id=document.getElementById('bI').value, q=parseInt(document.getElementById('bQ').value), it=items.find(i=>i.id==id); if(it && q>0) { cart.push({n:it.n, r:it.r, q, tot:it.r*q, id:it.id}); document.getElementById('cartD').classList.remove('hidden'); renderB(); } }
        function renderB() { let t=0; document.getElementById('cartL').innerHTML = cart.map(c=>{t+=c.tot; return `<div class="flex justify-between py-1"><span>${c.n} x${c.q}</span><span>Rs.${c.tot}</span></div>`}).join(''); document.getElementById('tD').innerText="Total: Rs."+t; }
        function clearFields(ids){ ids.forEach(id=>document.getElementById(id).value=''); }
        function openT(e, n) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(n).classList.add('active'); e.currentTarget.classList.add('active'); render(); }
        function pdf() { html2pdf().from(document.getElementById('pArea')).save('Receipt.pdf'); }
        function closeR() { document.getElementById('receiptModal').style.display='none'; }
        
        loadLocal(); sync();
    </script>
</body>
</html>
